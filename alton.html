<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alton Towers</title>
    <link rel="icon" type="image/x-icon" href="icons/favicon-alton.png">
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        max-width: 300px;
        width: 100%;
      }
      h1, h2 {
        color: #333;
        text-align: center;
        text-decoration: underline;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      li {
        background-color: #fff;
        padding: 10px;
        margin: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      li:hover {
        background-color: #f9f9f9;
      }
      .wait-time {
        font-weight: bold;
        min-width: 60px;
        text-align: right;
      }
      .closed {
        font-weight: bold;
        color: red;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .closed-duration {
        display: block;
        font-size: 11px;
        color: #666;
        width: 100%;
        text-align: center;
      }
      .green {
        color: rgb(25, 115, 40);
      }
      .orange {
        color: rgb(255, 165, 0);
      }
      .red {
        color: red;
      }
      .bottom-spacer {
        height: 50px;
      }
      .error-message {
        color: red;
        text-align: center;
        padding: 20px;
      }
      .loading {
        text-align: center;
        padding: 20px;
      }
      .retry-button {
        display: none;
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px auto;
      }
      .retry-button:hover {
        background-color: #45a049;
      }
      .last-updated {
        text-align: center;
        font-size: 12px;
        color: #666;
        margin-top: 10px;
      }
    </style>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Alton Towers</h1>
      <div id="status" class="loading">Loading wait times...</div>
      <div id="last-updated" class="last-updated"></div>
      <button id="retry-button" class="retry-button" onclick="loadRideData()">Retry</button>
      <!-- Section for dynamic ride categories -->
      <div id="ride-categories"></div>
      <div class="bottom-spacer"></div>
    </div>
    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCg7Iq1QAlhYpdaMza6mIHc8P5YOiziscA",
        authDomain: "queuetimes-c0e9f.firebaseapp.com",
        databaseURL: "https://queuetimes-c0e9f-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "queuetimes-c0e9f",
        storageBucket: "queuetimes-c0e9f.firebasestorage.app",
        messagingSenderId: "338197126640",
        appId: "1:338197126640:web:ab2a258cd0670f7c259135"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      
      // Select which park branch to load. Update this value to display another park's data.
      const currentPark = "AltonTowers";
      
      // Custom ride categories (adjust as needed for each park)
      const customCategories = {
          Coasters: [
              "Galactica",
              "Nemesis Reborn",
              "Oblivion",
              "Rita",
              "Spinball Whizzer",
              "TH13TEEN",
              "The Smiler",
              "Wicker Man",
          ],
          OtherRides: [
              "Nemesis Sub-Terra",
              "Congo River Rapids",
              "Hex - The Legend of the Towers",
              "Runaway Mine Train",
              "The Curse at Alton Manor",
              "Gangsta Granny: The Ride",
              "Toxicator",
          ],
          Skyride: [
              "Skyride to Dark Forest (From Forbidden Valley)",
              "Skyride to Towers St. (From Forbidden Valley)", 
              "Skyride to Forbidden Valley (from Dark Forest)",
              "Skyride to Forbidden Valley (from Towers St.)",
          ],
          Monorail: [
              "Monorail - Entrance Plaza",
              "Monorail - Hotels & Car Parks",          
          ],
      };
      
      // Rename rules for ride names
      const renameRules = {
          "Hex - The Legend of the Towers": "Hex",
          "Monorail - Entrance Plaza": "Entrance Plaza",
          "Monorail - Hotels & Car Parks": "Car Parks",
          "Skyride to Dark Forest (From Forbidden Valley)": "Forbidden Valley to Dark Forest",
          "Skyride to Towers St. (From Forbidden Valley)": "Forbidden Valley to Towers Street", 
          "Skyride to Forbidden Valley (from Dark Forest)": "Dark Forest to Forbidden Valley",
          "Skyride to Forbidden Valley (from Towers St.)": "Towers Street to Forbidden Valley",
      };
      
      function renameRide(rideName) {
          return renameRules[rideName] || rideName;
      }
      
      // Capitalize category names for display
      function capitalizeWords(str) {
        return str
          .split(/(?=[A-Z])/g)
          .join(' ')
          .replace(/\b\w/g, char => char.toUpperCase());
      }
      
      // Create list item for each ride
      function createRideListItem(ride) {
          const listItem = document.createElement('li');
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = ride.name;
          listItem.appendChild(nameSpan);
          
          const statusSpan = document.createElement('span');
          
          if (ride.is_open) {
              if (ride.wait_time <= 15) {
                  statusSpan.className = 'wait-time green';
              } else if (ride.wait_time <= 30) {
                  statusSpan.className = 'wait-time orange';
              } else {
                  statusSpan.className = 'wait-time red';
              }
              statusSpan.textContent = `${ride.wait_time} mins`;
          } else {
              statusSpan.className = 'closed';
              statusSpan.textContent = 'Closed';
              
              // Create the duration span
              const durationSpan = document.createElement('span');
              durationSpan.className = 'closed-duration';
              
              // Check if this is an "all day" closure
              if (ride.closureDuration === "ALL_DAY") {
                  durationSpan.textContent = 'All Day';
              } else if (ride.closureDuration) {
                  durationSpan.textContent = ride.closureDuration;
              }
              
              // Only append if there's content
              if (durationSpan.textContent) {
                  statusSpan.appendChild(durationSpan);
              }
          }
          
          listItem.appendChild(statusSpan);
          return listItem;
      }
      
      // Format last updated time
      function formatFirebaseLastUpdated(lastUpdatedStr) {
        const date = new Date(lastUpdatedStr);
        // Use getUTCHours and getUTCMinutes if you want to display UTC time
        const hours = date.getUTCHours().toString().padStart(2, '0');
        const minutes = date.getUTCMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      }
      
      // Compute how long a ride has been closed
      function formatClosureDuration(lastStatusChange) {
        if (!lastStatusChange) return '';
        const now = new Date();
        const closureTime = new Date(lastStatusChange);
        // Get today's start time (midnight)
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        // If the ride closed before today, return a special indicator
        if (lastStatusChange < todayStart) {
          return "ALL_DAY"; // Special marker to be handled in createRideListItem
        }
        const diffMs = now.getTime() - lastStatusChange;
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        return hours > 0 ? `(${hours}h ${minutes}m)` : `(${minutes}m)`;
      }
      
      // Process ride data from Firebase and update the display
      function processRideData(rides) {
        // Categorize rides according to customCategories.
        const categorizedRides = {};
        for (const category in customCategories) {
          categorizedRides[category] = [];
        }
        
        rides.forEach(ride => {
          // Map stored Firebase fields to those used by the display logic.
          ride.is_open = ride.lastStatus;
          ride.wait_time = ride.waitTime;
          if (!ride.is_open && ride.lastStatusChange) {
            ride.closureDuration = formatClosureDuration(ride.lastStatusChange);
          }
          
          for (const category in customCategories) {
            if (customCategories[category].includes(ride.name)) {
              categorizedRides[category].push(ride);
            }
          }
        });
        
        // Clear and re-populate each category section.
        for (const category in categorizedRides) {
          const categoryElement = document.getElementById(category.replace(/\s+/g, '-').toLowerCase());
          if (categoryElement) {
            const categoryList = categoryElement.querySelector('ul');
            categoryList.innerHTML = '';
            categorizedRides[category].sort((a, b) => renameRide(a.name).localeCompare(renameRide(b.name)));
            categorizedRides[category].forEach(ride => {
              const renamedRide = { ...ride, name: renameRide(ride.name) };
              const listItem = createRideListItem(renamedRide);
              categoryList.appendChild(listItem);
            });
          }
        }
        
        document.getElementById('status').style.display = 'none';
      }
      
      // Load ride data from Firebase for the current park
      async function loadRideData() {
        const statusElement = document.getElementById('status');
        statusElement.className = 'loading';
        statusElement.textContent = 'Loading wait times...';
        document.getElementById('retry-button').style.display = 'none';
        
        try {
          const snapshot = await database.ref(`rideStatus/${currentPark}`).once('value');
          const ridesData = snapshot.val() || {};
          // Convert the returned object into an array.
          const ridesArray = Object.keys(ridesData).map(key => ridesData[key]);
          processRideData(ridesArray);
          
          if (ridesArray.length > 0 && ridesArray[0].lastUpdated) {
            document.getElementById('last-updated').textContent = `Last updated: ${formatFirebaseLastUpdated(ridesArray[0].lastUpdated)}`;
          } else {
            document.getElementById('last-updated').textContent = 'Last updated: N/A';
          }
        } catch (error) {
          console.error('Error loading ride data from Firebase:', error);
          statusElement.className = 'error-message';
          statusElement.textContent = 'Failed to load wait times. Please try again later.';
          document.getElementById('retry-button').style.display = 'block';
        }
      }
      
      // Create DOM sections for each ride category.
      function createCategorySections() {
        const rideCategoriesContainer = document.getElementById('ride-categories');
        for (const category in customCategories) {
          const categorySection = document.createElement('div');
          const categoryTitle = document.createElement('h2');
          categoryTitle.textContent = capitalizeWords(category);
          categorySection.appendChild(categoryTitle);
          
          const categoryList = document.createElement('ul');
          categorySection.appendChild(categoryList);
          
          categorySection.id = category.replace(/\s+/g, '-').toLowerCase();
          rideCategoriesContainer.appendChild(categorySection);
        }
      }
      
      // Set up a background sync that refreshes the ride data every minute
      function setupBackgroundSync() {
        createCategorySections();
        loadRideData();
        
        const ONE_MINUTE = 60 * 1000;
        setInterval(() => {
          loadRideData();
        }, ONE_MINUTE);
        
        // Keep the Firebase connection alive
        setInterval(() => {
          database.ref('.info/connected').once('value');
        }, 5 * 60 * 1000);
      }
      
      // Initialize the app
      setupBackgroundSync();
    </script>
  </body>
</html>
